name: Deploy Medusa Backend

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Deploy Medusa backend via SSM
        id: deploy_ssm
        continue-on-error: true
        run: |
          set -euxo pipefail
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=InstanceIds,Values=${INSTANCE_ID}" \
            --comment "Deploy Medusa backend" \
            --parameters commands='["set -e","echo \"ssm-preflight-start\"","whoami || true","ls -ld /home/ubuntu /home/ubuntu/ldc-medusa /home/ubuntu/ldc-medusa/scripts || true","bash -euxo pipefail /home/ubuntu/ldc-medusa/scripts/deploy-medusa.sh"]' \
            --timeout-seconds 3600 \
            --query "Command.CommandId" \
            --output text)
          echo "SSM command id: ${COMMAND_ID}"

          STATUS="InProgress"
          ELAPSED=0
          TIMEOUT=3600
          LAST_DETAILS=""
          while [ "$STATUS" = "InProgress" ] || [ "$STATUS" = "Pending" ] || [ "$STATUS" = "Delayed" ]; do
            sleep 10
            ELAPSED=$((ELAPSED + 10))
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${INSTANCE_ID}" \
              --query "Status" \
              --output text)
            LAST_DETAILS=$(aws ssm list-command-invocations \
              --command-id "$COMMAND_ID" \
              --details \
              --query "CommandInvocations[0].StatusDetails" \
              --output text || true)
            echo "SSM status: $STATUS (elapsed ${ELAPSED}s)"
            echo "SSM status details: ${LAST_DETAILS}"
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
              echo "SSM command timed out after ${TIMEOUT}s"
              break
            fi
          done

          echo "===== SSM invocation summary ====="
          aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --details
          echo "===== SSM invocation payload ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}"
          echo "===== SSM standard output ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}" \
            --query "StandardOutputContent" \
            --output text || true
          echo "===== SSM standard error ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}" \
            --query "StandardErrorContent" \
            --output text || true

          if [ "$STATUS" != "Success" ]; then
            echo "SSM deploy failed with status: $STATUS"
            exit 1
          fi
      - name: Deploy Medusa backend via SSH fallback
        id: deploy_ssh
        if: steps.deploy_ssm.outcome != 'success'
        run: |
          set -euxo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/id_rsa \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "/home/ubuntu/ldc-medusa/scripts/deploy-medusa.sh"
      - name: Ensure deploy succeeded
        if: steps.deploy_ssm.outcome != 'success' && steps.deploy_ssh.outcome != 'success'
        run: |
          echo "Both SSM deploy and SSH fallback failed."
          exit 1
      - name: Health check
        run: |
          curl -fsS --retry 10 --retry-connrefused --retry-delay 5 https://api.lovettsldc.com/health
