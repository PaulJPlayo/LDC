name: Deploy Medusa Backend

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Deploy Medusa backend via SSM
        run: |
          set -euxo pipefail
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=InstanceIds,Values=${INSTANCE_ID}" \
            --comment "Deploy Medusa backend" \
            --parameters commands='["set -euxo pipefail","bash /home/ubuntu/ldc-medusa/scripts/deploy-medusa.sh"]' \
            --timeout-seconds 3600 \
            --query "Command.CommandId" \
            --output text)
          echo "SSM command id: ${COMMAND_ID}"

          STATUS="InProgress"
          ELAPSED=0
          TIMEOUT=3600
          LAST_DETAILS=""
          while [ "$STATUS" = "InProgress" ] || [ "$STATUS" = "Pending" ] || [ "$STATUS" = "Delayed" ]; do
            sleep 10
            ELAPSED=$((ELAPSED + 10))
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${INSTANCE_ID}" \
              --query "Status" \
              --output text)
            LAST_DETAILS=$(aws ssm list-command-invocations \
              --command-id "$COMMAND_ID" \
              --details \
              --query "CommandInvocations[0].StatusDetails" \
              --output text || true)
            echo "SSM status: $STATUS (elapsed ${ELAPSED}s)"
            echo "SSM status details: ${LAST_DETAILS}"
            if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
              echo "SSM command timed out after ${TIMEOUT}s"
              break
            fi
          done

          echo "===== SSM invocation summary ====="
          aws ssm list-command-invocations \
            --command-id "$COMMAND_ID" \
            --details
          echo "===== SSM invocation payload ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}"
          echo "===== SSM standard output ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}" \
            --query "StandardOutputContent" \
            --output text || true
          echo "===== SSM standard error ====="
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${INSTANCE_ID}" \
            --query "StandardErrorContent" \
            --output text || true

          if [ "$STATUS" != "Success" ]; then
            echo "SSM deploy failed with status: $STATUS"
            exit 1
          fi
      - name: Health check
        run: |
          curl -fsS --retry 10 --retry-connrefused --retry-delay 5 https://api.lovettsldc.com/health
