name: Deploy Medusa Backend

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Deploy Medusa backend via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --comment "Deploy Medusa backend" \
            --parameters commands='["set -e","sudo -u ubuntu -H bash -lc \"/home/ubuntu/ldc-medusa/scripts/deploy-medusa.sh\""]' \
            --query "Command.CommandId" \
            --output text)

          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" || true

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "Status" \
            --output text)

          echo "SSM status: $STATUS"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --query "StandardErrorContent" \
            --output text

          if [ "$STATUS" != "Success" ]; then
            echo "SSM deploy failed with status: $STATUS"
            exit 1
          fi
      - name: Health check
        run: |
          curl -fsS --retry 10 --retry-connrefused --retry-delay 5 https://api.lovettsldc.com/health
