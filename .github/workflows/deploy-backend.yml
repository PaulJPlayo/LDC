name: Deploy Medusa Backend

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Deploy Medusa backend via SSM
        id: deploy_ssm
        run: |
          set -euxo pipefail
          INSTANCE_ID="${{ secrets.EC2_INSTANCE_ID }}"
          TIMEOUT=3600

          run_deploy_command() {
            local command_id status elapsed last_details
            command_id=$(aws ssm send-command \
              --document-name "AWS-RunShellScript" \
              --targets "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --comment "Deploy Medusa backend" \
              --parameters commands='["set -e","echo \"ssm-preflight-start\"","whoami || true","ls -ld /home/ubuntu /home/ubuntu/ldc-medusa /home/ubuntu/ldc-medusa/scripts || true","bash -euxo pipefail /home/ubuntu/ldc-medusa/scripts/deploy-medusa.sh"]' \
              --timeout-seconds ${TIMEOUT} \
              --query "Command.CommandId" \
              --output text)
            echo "SSM command id: ${command_id}"

            status="InProgress"
            elapsed=0
            last_details=""
            while [ "$status" = "InProgress" ] || [ "$status" = "Pending" ] || [ "$status" = "Delayed" ]; do
              sleep 10
              elapsed=$((elapsed + 10))
              status=$(aws ssm get-command-invocation \
                --command-id "$command_id" \
                --instance-id "${INSTANCE_ID}" \
                --query "Status" \
                --output text)
              last_details=$(aws ssm list-command-invocations \
                --command-id "$command_id" \
                --details \
                --query "CommandInvocations[0].StatusDetails" \
                --output text || true)
              echo "SSM status: $status (elapsed ${elapsed}s)"
              echo "SSM status details: ${last_details}"
              if [ "$elapsed" -ge "$TIMEOUT" ]; then
                echo "SSM command timed out after ${TIMEOUT}s"
                break
              fi
            done

            echo "===== SSM invocation summary ====="
            aws ssm list-command-invocations \
              --command-id "$command_id" \
              --details
            echo "===== SSM invocation payload ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}"
            echo "===== SSM standard output ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardOutputContent" \
              --output text || true
            echo "===== SSM standard error ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardErrorContent" \
              --output text || true

            if [ "$status" != "Success" ]; then
              echo "SSM deploy failed with status: $status"
              return 1
            fi

            return 0
          }

          update_ssm_agent() {
            local command_id status elapsed
            command_id=$(aws ssm send-command \
              --document-name "AWS-UpdateSSMAgent" \
              --targets "Key=InstanceIds,Values=${INSTANCE_ID}" \
              --comment "Update SSM agent before deploy retry" \
              --timeout-seconds 600 \
              --query "Command.CommandId" \
              --output text)
            echo "SSM update command id: ${command_id}"

            status="InProgress"
            elapsed=0
            while [ "$status" = "InProgress" ] || [ "$status" = "Pending" ] || [ "$status" = "Delayed" ]; do
              sleep 10
              elapsed=$((elapsed + 10))
              status=$(aws ssm get-command-invocation \
                --command-id "$command_id" \
                --instance-id "${INSTANCE_ID}" \
                --query "Status" \
                --output text)
              echo "SSM update status: $status (elapsed ${elapsed}s)"
            done

            echo "===== SSM update invocation payload ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" || true
            echo "===== SSM update invocation summary ====="
            aws ssm list-command-invocations \
              --command-id "$command_id" \
              --details || true
            echo "===== SSM update plugin payload ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" \
              --plugin-name "aws:updateSsmAgent" || true
            echo "===== SSM update standard output ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardOutputContent" \
              --output text || true
            echo "===== SSM update standard error ====="
            aws ssm get-command-invocation \
              --command-id "$command_id" \
              --instance-id "${INSTANCE_ID}" \
              --query "StandardErrorContent" \
              --output text || true

            if [ "$status" != "Success" ]; then
              echo "SSM agent update failed with status: $status"
              return 1
            fi

            return 0
          }

          if ! run_deploy_command; then
            echo "Initial SSM deploy failed; updating SSM agent and retrying once."
            update_ssm_agent
            run_deploy_command
          fi
      - name: Health check
        run: |
          curl -fsS --retry 10 --retry-connrefused --retry-delay 5 https://api.lovettsldc.com/health
